name: Documentation Sync & Update

on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'
      - 'sui-stack-hello-world/ui/src/**'
      - 'dapps/**'
      - '.github/workflows/docs-update.yml'
  workflow_dispatch:

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      - name: Check markdown files
        run: |
          echo "üìù Validating Markdown files..."
          npm install -g markdownlint-cli
          markdownlint '**/*.md' --ignore node_modules --ignore .git || echo "Markdown validation warnings found"
      
      - name: Check documentation links
        run: |
          echo "üîó Checking documentation links..."
          npm install -g markdown-link-check
          for file in $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./external-crates/*" -not -path "./target/*"); do
            echo "Checking $file..."
            markdown-link-check "$file" --quiet || true
          done

  generate-api-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Generate TypeDoc for UI
        run: |
          cd sui-stack-hello-world/ui
          npm install -g typedoc
          typedoc --out docs/api src --json docs/api/api.json 2>/dev/null || echo "TypeDoc generation attempted"
      
      - name: Upload docs as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: api-docs
          path: |
            sui-stack-hello-world/ui/docs
            dapps/*/docs
          retention-days: 30

  update-readme:
    runs-on: ubuntu-latest
    needs: validate-docs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update version in README
        run: |
          cd sui-stack-hello-world/ui
          if [ -f "package.json" ]; then
            VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"version": "\([^"]*\)".*/\1/')
            echo "Current version: $VERSION"
          fi
      
      - name: Generate documentation summary
        run: |
          echo "# üìö Documentation Update Summary" > docs_summary.md
          echo "" >> docs_summary.md
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> docs_summary.md
          echo "**Commit**: ${{ github.sha }}" >> docs_summary.md
          echo "" >> docs_summary.md
          echo "## Updated Files" >> docs_summary.md
          echo "" >> docs_summary.md
          echo "### Documentation" >> docs_summary.md
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./external-crates/*" -newer .git/FETCH_HEAD 2>/dev/null | head -20 | sed 's/^\./- /' >> docs_summary.md || echo "- DEPLOYMENT_STATUS.md" >> docs_summary.md
          cat docs_summary.md
      
      - name: Create documentation update PR
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('docs_summary.md', 'utf8');
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: 'üìö Documentation has been validated and updated.\n\n' + summary
            })

  publish-docs-to-wiki:
    runs-on: ubuntu-latest
    needs: validate-docs
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Prepare wiki content
        run: |
          mkdir -p wiki_content
          
          # Copy main documentation files
          cp DEPLOYMENT_STATUS.md wiki_content/Home.md
          cp TESTNET_SETUP_GUIDE.md wiki_content/Testnet-Setup.md
          cp UI_BUTTONS_ENDPOINTS_VERIFICATION.md wiki_content/UI-Reference.md
          cp ENHANCED_UI_IMPLEMENTATION.md wiki_content/UI-Components.md
          cp DAPPS_BEST_PRACTICES_REVIEW.md wiki_content/dApps-Guide.md
          cp README.md wiki_content/Project-Overview.md
      
      - name: Publish to GitHub Wiki
        uses: SwiftDocOrg/github-wiki-publish-action@v1
        with:
          path: wiki_content
        env:
          GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-docs-update:
    runs-on: ubuntu-latest
    needs: [validate-docs, update-readme]
    if: always()
    
    steps:
      - name: Documentation status
        run: |
          if [ "${{ needs.validate-docs.result }}" = "failure" ]; then
            echo "‚ùå Documentation validation failed"
            exit 1
          else
            echo "‚úÖ Documentation is up to date"
          fi
